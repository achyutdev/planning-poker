<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning Poker - Session</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #667eea;
      --primary-dark: #5568d3;
      --secondary-color: #764ba2;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-light: #f9fafb;
      --bg-card: #ffffff;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 24px;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    .header {
      background: var(--bg-card);
      padding: 24px 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .header h1 {
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 1.875rem;
      letter-spacing: -0.025em;
    }
    
    .session-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .session-info strong {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .info-badge {
      background: var(--bg-light);
      padding: 4px 12px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .sidebar {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.8);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .sidebar h2 {
      font-size: 1.125rem;
      margin-bottom: 16px;
      color: var(--text-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sidebar h2::before {
      content: 'üë•';
      font-size: 1.25rem;
    }
    
    .participant-list {
      list-style: none;
    }
    
    .participant {
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
    }
    
    .participant:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }
    
    .participant.voted {
      background: #d1fae5;
      border-color: var(--success-color);
    }
    
    .participant-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9375rem;
    }
    
    .vote-status {
      font-size: 1.25rem;
      color: var(--success-color);
    }
    
    .voting-area {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .story-info {
      text-align: center;
      margin-bottom: 40px;
      background: var(--bg-card);
      padding: 40px 32px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }
    
    .story-info h2 {
      color: var(--text-secondary);
      margin-bottom: 16px;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }
    
    .story-info h3 {
      color: var(--text-primary);
      font-size: 1.875rem;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 24px;
    }
    
    .timer {
      font-size: 3.5em;
      font-weight: 700;
      color: var(--primary-color);
      margin: 20px 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      text-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
      letter-spacing: 0.05em;
      transition: all 0.3s ease;
      position: relative;
      display: inline-block;
    }
    
    .timer.warning {
      color: #ff9800;
      animation: pulse 1s ease-in-out infinite;
    }
    
    .timer.danger {
      color: #f44336;
      animation: shake 0.5s ease-in-out infinite, pulse 0.5s ease-in-out infinite;
      text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.9;
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0) scale(1); }
      25% { transform: translateX(-5px) scale(1.05); }
      75% { transform: translateX(5px) scale(1.05); }
    }
    
    .timer-container {
      position: relative;
      display: inline-block;
      padding: 24px 48px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 20px;
      border: 3px solid #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      margin: 24px auto;
    }
    
    .timer-container.warning {
      border-color: #ff9800;
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .timer-container.danger {
      border-color: #f44336;
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(229, 57, 53, 0.15) 100%);
      box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
      animation: containerShake 0.5s ease-in-out infinite;
    }
    
    @keyframes containerShake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-1deg); }
      75% { transform: rotate(1deg); }
    }
    
    .timer-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .timer-progress {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      margin-top: 20px;
      overflow: hidden;
      position: relative;
    }
    
    .timer-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
      transition: width 1s linear, background 0.3s ease;
    }
    
    .timer-progress-bar.warning {
      background: linear-gradient(90deg, #ff9800 0%, #ffc107 100%);
    }
    
    .timer-progress-bar.danger {
      background: linear-gradient(90deg, #f44336 0%, #e53935 100%);
    }
    
    .facilitator-controls {
      margin-bottom: 32px;
      background: var(--bg-light);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    
    .facilitator-controls h2 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.2s ease;
      background: var(--bg-card);
    }
    
    .form-group input:hover {
      border-color: var(--primary-color);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-inline {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .form-inline .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
      background: var(--danger-color);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
      background: #da190b;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    #votingCards {
      margin: 40px 0;
    }
    
    #votingCards h3 {
      font-size: 1.375rem;
      color: var(--text-primary);
      margin-bottom: 28px;
      font-weight: 600;
      text-align: center;
    }
    
    .voting-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .card {
      aspect-ratio: 2/3;
      background: var(--bg-card);
      border: 3px solid var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      font-weight: 700;
      color: var(--primary-color);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
      border-color: var(--primary-dark);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card.selected {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      transform: translateY(-8px) scale(1.08);
      box-shadow: 0 16px 32px rgba(102, 126, 234, 0.4);
      border-color: var(--secondary-color);
    }
    
    .card.selected::before {
      opacity: 0;
    }
    
    .results {
      margin-top: 40px;
    }
    
    .results h3 {
      margin-bottom: 32px;
      color: var(--text-primary);
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .result-item {
      background: var(--bg-light);
      padding: 20px 24px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid var(--border-color);
      transition: all 0.2s ease;
      min-height: 70px;
    }
    
    .result-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .result-item span:first-child {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1.0625rem;
    }
    
    .result-vote {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      background: var(--bg-card);
      padding: 10px 20px;
      border-radius: 10px;
      min-width: 60px;
      text-align: center;
    }
    
    .waiting-message {
      text-align: center;
      color: var(--text-secondary);
      font-size: 1.125rem;
      padding: 48px 24px;
      background: var(--bg-light);
      border-radius: 12px;
      border: 2px dashed var(--border-color);
    }
    
    .waiting-message::before {
      content: '‚è≥';
      display: block;
      font-size: 3em;
      margin-bottom: 16px;
    }
    
    .status-message {
      text-align: center;
      padding: 20px 32px;
      border-radius: 12px;
      margin: 32px 0;
      font-weight: 600;
      font-size: 1.125rem;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .status-success {
      background: #d1fae5;
      color: #065f46;
      border-color: var(--success-color);
    }
    
    .status-success::before {
      content: 'üéâ';
      font-size: 1.5rem;
    }
    
    .status-info {
      background: #dbeafe;
      color: #1e40af;
      border-color: var(--primary-color);
    }
    
    .hidden {
      display: none;
    }
    
    .button-group {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .history-section {
      margin-top: 40px;
      padding: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }
    
    .history-section h3 {
      margin-bottom: 24px;
      color: var(--text-primary);
      font-size: 1.5rem;
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 12px;
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .history-item {
      background: var(--bg-light);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 0;
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--primary-color);
      transition: all 0.2s ease;
    }
    
    .history-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .history-story-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1.125rem;
    }
    
    .history-timestamp {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .history-stats {
      display: flex;
      gap: 24px;
      margin: 12px 0;
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }
    
    .history-stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .history-stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .history-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .history-votes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .history-vote-item {
      background: var(--bg-card);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.875rem;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    
    .history-vote-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }
    
    .history-vote-name {
      color: var(--text-secondary);
      margin-right: 8px;
      font-weight: 500;
    }
    
    .history-vote-value {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1rem;
    }
    
    .name-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .name-modal.active {
      display: flex;
    }
    
    .name-modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 48px;
      max-width: 480px;
      width: 90%;
      box-shadow: var(--shadow-lg);
      transform: translateY(0);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .name-modal-content h2 {
      color: var(--text-primary);
      margin-bottom: 12px;
      font-size: 2rem;
      text-align: center;
      font-weight: 700;
    }
    
    .name-modal-content p {
      color: var(--text-secondary);
      margin-bottom: 32px;
      text-align: center;
      font-size: 1rem;
      line-height: 1.5;
    }
    
    .name-modal-content .form-group {
      margin-bottom: 24px;
    }
    
    .name-modal-content label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9375rem;
    }
    
    .name-modal-content input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      background: var(--bg-light);
    }
    
    .name-modal-content input:hover {
      border-color: var(--primary-color);
    }
    
    .name-modal-content input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      background: var(--bg-card);
    }
    
    .name-modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    
    .name-modal-buttons button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-modal-cancel {
      background: var(--bg-light);
      color: var(--text-secondary);
      border: 2px solid var(--border-color);
    }
    
    .btn-modal-cancel:hover {
      background: var(--bg-card);
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }
    
    .btn-modal-join {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
    }
    
    .btn-modal-join:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-modal-join:active {
      transform: translateY(0);
    }
    
    .btn-modal-join:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .modal-icon {
      font-size: 3.5rem;
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-content {
        padding: 20px;
      }
      
      .sidebar {
        padding: 20px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        font-size: 15px;
      }
      
      .main-content {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      
      .sidebar {
        position: static;
        height: auto;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .voting-cards {
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
        gap: 12px;
      }
      
      .card {
        font-size: 1.5rem;
        padding: 16px;
      }
      
      .name-modal-content {
        padding: 32px 24px;
      }
      
      .name-modal-content h2 {
        font-size: 1.75rem;
      }
      
      .results-grid {
        grid-template-columns: 1fr;
      }
      
      .history-stats {
        flex-direction: column;
        gap: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.25rem;
      }
      
      .voting-cards {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .facilitator-controls {
        padding: 16px;
      }
      
      .name-modal-content {
        padding: 24px 20px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button-group button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Name Entry Modal -->
  <div id="nameModal" class="name-modal">
    <div class="name-modal-content">
      <div class="modal-icon">üëã</div>
      <h2>Welcome to Planning Poker</h2>
      <p>Please enter your name to join the session</p>
      <div class="form-group">
        <label for="nameInput">Your Name</label>
        <input 
          type="text" 
          id="nameInput" 
          placeholder="e.g., John Doe" 
          autocomplete="name"
          autofocus
        >
      </div>
      <div class="name-modal-buttons">
        <button class="btn-modal-cancel" onclick="cancelNameEntry()">Cancel</button>
        <button class="btn-modal-join" id="joinButton" onclick="submitName()">Join Session</button>
      </div>
    </div>
  </div>
  <div class="header">
    <h1>üÉè Planning Poker</h1>
    <div class="session-info">
      Session ID: <strong id="sessionId"></strong> | 
      Facilitator: <strong id="facilitatorName"></strong>
    </div>
  </div>
  
  <div class="main-content">
    <div class="sidebar">
      <h2>Team Members (<span id="participantCount">0</span>)</h2>
      <ul class="participant-list" id="participantList"></ul>
    </div>
    
    <div class="voting-area">
      <!-- Facilitator Controls -->
      <div id="facilitatorControls" class="facilitator-controls hidden">
        <h2>Start New Story</h2>
        <div class="form-inline">
          <div class="form-group">
            <label for="storyName">Story/Ticket Name</label>
            <input type="text" id="storyName" placeholder="e.g., USER-123: Add login feature">
          </div>
          <div class="form-group">
            <label for="timerDuration">Time Limit (seconds)</label>
            <input type="number" id="timerDuration" value="15" min="10" max="300">
          </div>
          <button class="btn btn-primary" onclick="startVoting()">Start Voting</button>
        </div>
      </div>
      
      <!-- Story Display -->
      <div id="storyDisplay" class="story-info hidden">
        <h2>Current Story</h2>
        <h3 id="currentStoryName"></h3>
        <div class="timer-container" id="timerContainer">
          <div class="timer-label">Time Remaining</div>
          <div class="timer" id="timer">0:00</div>
          <div class="timer-progress">
            <div class="timer-progress-bar" id="timerProgressBar"></div>
          </div>
        </div>
        <div id="statusMessage" class="status-message hidden"></div>
      </div>
      
      <!-- Voting Cards -->
      <div id="votingCards" class="hidden">
        <h3>Select Your Estimate</h3>
        <div class="voting-cards">
          <div class="card" onclick="selectVote('0')">0</div>
          <div class="card" onclick="selectVote('1')">1</div>
          <div class="card" onclick="selectVote('2')">2</div>
          <div class="card" onclick="selectVote('3')">3</div>
          <div class="card" onclick="selectVote('5')">5</div>
          <div class="card" onclick="selectVote('8')">8</div>
          <div class="card" onclick="selectVote('13')">13</div>
          <div class="card" onclick="selectVote('21')">21</div>
          <div class="card" onclick="selectVote('?')">?</div>
        </div>
      </div>
      
      <!-- Results -->
      <div id="results" class="results hidden">
        <h3>Voting Results</h3>
        <div class="results-grid" id="resultsGrid"></div>
        
        <div id="facilitatorResultControls" class="button-group hidden">
          <button class="btn btn-primary" onclick="startNewVoting()">New Story</button>
          <button class="btn btn-danger" onclick="endVoting()">End Session</button>
        </div>
      </div>
      
      <!-- Waiting Message -->
      <div id="waitingMessage" class="waiting-message">
        Waiting for facilitator to start voting...
      </div>
      
      <!-- History Section -->
      <div id="historySection" class="history-section hidden">
        <h3>üìã Estimation History</h3>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>
  </div>
  
  <script>
    const socket = io();
    let sessionId = '';
    let userName = '';
    let isFacilitator = false;
    let selectedVote = null;
    let timerInterval = null;
    let audioContext = null;
    
    // Initialize audio context
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    
    // Play beep sound
    function playBeep(frequency = 800, duration = 100) {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }
    
    // Initialize
    window.onload = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const pathParts = window.location.pathname.split('/');
      sessionId = pathParts[pathParts.length - 1];
      userName = urlParams.get('name') || '';
      isFacilitator = urlParams.get('facilitator') === 'true';
      
      if (!sessionId) {
        alert('Invalid session. Redirecting to home...');
        window.location.href = '/';
        return;
      }
      
      // Show custom modal for name if not provided
      if (!userName || userName.trim() === '') {
        showNameModal();
        return;
      }
      
      userName = userName.trim();
      document.getElementById('sessionId').textContent = sessionId;
      
      socket.emit('join-session', { sessionId, userName, isFacilitator });
    };
    
    function showNameModal() {
      document.getElementById('nameModal').classList.add('active');
      const nameInput = document.getElementById('nameInput');
      nameInput.focus();
      
      // Allow Enter key to submit
      nameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitName();
        }
      });
      
      // Enable/disable join button based on input
      nameInput.addEventListener('input', () => {
        const joinButton = document.getElementById('joinButton');
        joinButton.disabled = !nameInput.value.trim();
      });
    }
    
    function submitName() {
      const nameInput = document.getElementById('nameInput');
      const name = nameInput.value.trim();
      
      if (!name) {
        nameInput.focus();
        nameInput.style.borderColor = '#f44336';
        setTimeout(() => {
          nameInput.style.borderColor = '';
        }, 1000);
        return;
      }
      
      userName = name;
      document.getElementById('nameModal').classList.remove('active');
      document.getElementById('sessionId').textContent = sessionId;
      
      socket.emit('join-session', { sessionId, userName, isFacilitator });
    }
    
    function cancelNameEntry() {
      window.location.href = '/';
    }
    
    // Socket event listeners
    socket.on('session-state', (data) => {
      document.getElementById('facilitatorName').textContent = data.facilitator;
      updateParticipants(data.participants);
      
      if (data.isFacilitator) {
        document.getElementById('facilitatorControls').classList.remove('hidden');
        document.getElementById('waitingMessage').classList.add('hidden');
      }
      
      if (data.votingActive && data.currentStory) {
        showVotingUI(data.currentStory);
      }
      
      // Display history if available
      if (data.history && data.history.length > 0) {
        displayHistory(data.history);
      }
    });
    
    socket.on('participant-joined', (data) => {
      updateParticipants(data.participants);
    });
    
    socket.on('participant-left', (data) => {
      updateParticipants(data.participants);
    });
    
    socket.on('voting-started', (data) => {
      showVotingUI(data.storyName);
      startTimer(data.timerDuration, data.timerStart);
      selectedVote = null;
      document.querySelectorAll('.card').forEach(card => card.classList.remove('selected'));
      document.getElementById('results').classList.add('hidden');
    });
    
    socket.on('votes-update', (data) => {
      updateVoteStatus(data.votes);
      
      if (isFacilitator) {
        const message = `${data.votedCount} of ${data.totalParticipants} members have voted`;
        showStatus(message, 'info');
        
        if (data.votedCount === data.totalParticipants && data.totalParticipants > 0) {
          showStatus('All votes are in! You can reveal the results.', 'success');
        }
      }
    });
    
    socket.on('votes-revealed', (data) => {
      clearInterval(timerInterval);
      showResults(data.votes, data.autoRevealed);
    });
    
    socket.on('voting-ended', (data) => {
      clearInterval(timerInterval);
      document.getElementById('storyDisplay').classList.add('hidden');
      document.getElementById('votingCards').classList.add('hidden');
      document.getElementById('results').classList.add('hidden');
      document.getElementById('statusMessage').classList.add('hidden');
      
      if (!isFacilitator) {
        document.getElementById('waitingMessage').classList.remove('hidden');
      }
      
      // Update history display
      if (data.history && data.history.length > 0) {
        displayHistory(data.history);
      }
    });
    
    socket.on('session-ended', (data) => {
      alert(data.message);
      window.location.href = '/';
    });
    
    socket.on('error', (data) => {
      alert(data.message);
      window.location.href = '/';
    });
    
    // Functions
    function updateParticipants(participants) {
      const list = document.getElementById('participantList');
      const count = document.getElementById('participantCount');
      
      list.innerHTML = participants.map(p => `
        <li class="participant" id="participant-${p.id}">
          <span class="participant-name">${p.name}</span>
          <span class="vote-status"></span>
        </li>
      `).join('');
      
      count.textContent = participants.length;
    }
    
    function updateVoteStatus(votes) {
      votes.forEach(vote => {
        const elements = document.querySelectorAll('.participant');
        elements.forEach(el => {
          if (el.querySelector('.participant-name').textContent === vote.userName) {
            if (vote.voted) {
              el.classList.add('voted');
              el.querySelector('.vote-status').textContent = '‚úì';
            }
          }
        });
      });
    }
    
    function startVoting() {
      const storyName = document.getElementById('storyName').value.trim();
      const timerDuration = parseInt(document.getElementById('timerDuration').value);
      
      if (!storyName) {
        alert('Please enter a story name');
        return;
      }
      
      socket.emit('start-voting', { sessionId, storyName, timerDuration });
      document.getElementById('storyName').value = '';
    }
    
    function showVotingUI(storyName) {
      document.getElementById('waitingMessage').classList.add('hidden');
      document.getElementById('storyDisplay').classList.remove('hidden');
      document.getElementById('currentStoryName').textContent = storyName;
      
      if (!isFacilitator) {
        document.getElementById('votingCards').classList.remove('hidden');
      } else {
        document.getElementById('votingCards').classList.add('hidden');
      }
      
      // Reset participants vote status
      document.querySelectorAll('.participant').forEach(p => {
        p.classList.remove('voted');
        p.querySelector('.vote-status').textContent = '';
      });
    }
    
    function startTimer(duration, startTime) {
      const endTime = startTime + (duration * 1000);
      const totalDuration = duration;
      let lastBeepSecond = -1;
      
      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const timerEl = document.getElementById('timer');
        const timerContainer = document.getElementById('timerContainer');
        const progressBar = document.getElementById('timerProgressBar');
        
        timerEl.textContent = display;
        
        // Calculate progress percentage
        const progressPercent = (remaining / totalDuration) * 100;
        progressBar.style.width = progressPercent + '%';
        
        // Remove all state classes
        timerEl.classList.remove('warning', 'danger');
        timerContainer.classList.remove('warning', 'danger');
        progressBar.classList.remove('warning', 'danger');
        
        // Add appropriate state classes and sound effects based on remaining time
        if (remaining <= 5 && remaining > 0) {
          timerEl.classList.add('danger');
          timerContainer.classList.add('danger');
          progressBar.classList.add('danger');
          
          // Play urgent beep every second for last 5 seconds
          if (remaining !== lastBeepSecond) {
            playBeep(1000, 150);
            lastBeepSecond = remaining;
          }
        } else if (remaining <= 10) {
          timerEl.classList.add('warning');
          timerContainer.classList.add('warning');
          progressBar.classList.add('warning');
          
          // Play warning beep at 10 seconds
          if (remaining === 10 && lastBeepSecond !== 10) {
            playBeep(600, 200);
            lastBeepSecond = 10;
          }
        }
        
        if (remaining === 0) {
          clearInterval(timerInterval);
          playBeep(400, 300); // Final beep
          if (isFacilitator) {
            socket.emit('reveal-votes', { sessionId });
          }
        }
      }, 1000);
    }
    
    function selectVote(vote) {
      if (isFacilitator) return;
      
      selectedVote = vote;
      document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      socket.emit('submit-vote', { sessionId, vote });
      showStatus('Your vote has been submitted!', 'success');
    }
    
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      statusEl.classList.remove('hidden');
    }
    
    function showResults(votes, autoRevealed) {
      document.getElementById('votingCards').classList.add('hidden');
      document.getElementById('results').classList.remove('hidden');
      
      const resultsGrid = document.getElementById('resultsGrid');
      resultsGrid.innerHTML = votes.map(v => `
        <div class="result-item">
          <span>${v.userName}</span>
          <span class="result-vote">${v.vote}</span>
        </div>
      `).join('');
      
      if (isFacilitator) {
        document.getElementById('facilitatorResultControls').classList.remove('hidden');
      }
      
      // Calculate statistics
      const numericVotes = votes.map(v => v.vote).filter(v => v !== '?').map(Number);
      if (numericVotes.length > 0) {
        const avg = (numericVotes.reduce((a, b) => a + b, 0) / numericVotes.length).toFixed(1);
        const min = Math.min(...numericVotes);
        const max = Math.max(...numericVotes);
        const statusPrefix = autoRevealed ? 'üéâ All votes in! ' : '';
        showStatus(`${statusPrefix}Average: ${avg} | Min: ${min} | Max: ${max}`, 'info');
      } else if (autoRevealed) {
        showStatus('üéâ All votes are in!', 'success');
      }
    }
    
    function startNewVoting() {
      if (!isFacilitator) return;
      socket.emit('end-voting', { sessionId });
    }
    
    function endVoting() {
      if (!isFacilitator) return;
      if (confirm('Are you sure you want to end this session?')) {
        socket.emit('end-voting', { sessionId });
        window.location.href = '/';
      }
    }
    
    function displayHistory(history) {
      const historySection = document.getElementById('historySection');
      const historyList = document.getElementById('historyList');
      
      if (!history || history.length === 0) {
        historySection.classList.add('hidden');
        return;
      }
      
      historySection.classList.remove('hidden');
      
      // Sort history by timestamp (newest first)
      const sortedHistory = [...history].reverse();
      
      historyList.innerHTML = sortedHistory.map(item => {
        const date = new Date(item.completedAt);
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let statsHTML = '';
        if (item.statistics) {
          statsHTML = `
            <div class="history-stats">
              <div class="history-stat">
                <span class="history-stat-label">Avg:</span>
                <span>${item.statistics.average}</span>
              </div>
              <div class="history-stat">
                <span class="history-stat-label">Min:</span>
                <span>${item.statistics.min}</span>
              </div>
              <div class="history-stat">
                <span class="history-stat-label">Max:</span>
                <span>${item.statistics.max}</span>
              </div>
            </div>
          `;
        }
        
        const votesHTML = `
          <div class="history-votes">
            ${item.votes.map(v => `
              <div class="history-vote-item">
                <span class="history-vote-name">${v.userName}:</span>
                <span class="history-vote-value">${v.vote}</span>
              </div>
            `).join('')}
          </div>
        `;
        
        return `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-story-name">${item.storyName}</div>
              <div class="history-timestamp">${timeStr}</div>
            </div>
            ${statsHTML}
            ${votesHTML}
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
